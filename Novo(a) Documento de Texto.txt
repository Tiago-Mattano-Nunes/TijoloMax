CREATE DATABASE ProjetoFinal;

USE ProjetoFinal;

CREATE TABLE Usuario (
idUsuario INT AUTO_INCREMENT PRIMARY KEY,
nome VARCHAR(255) NOT NULL,
senha VARCHAR(255) NOT NULL,
email VARCHAR(255) NOT NULL,
telefone VARCHAR(20) NOT NULL,
cpf VARCHAR(14) NOT NULL
);

CREATE TABLE categorias (
  idCategoria INT AUTO_INCREMENT PRIMARY KEY,
  nome varchar(45) DEFAULT NULL
);

CREATE TABLE Produtos (
idProdutos INT AUTO_INCREMENT PRIMARY KEY,
idCategoria INT,
nomeProdutos VARCHAR(255) NOT NULL,
imagem longblob,
categoria int,
descricao TEXT,
preco DECIMAL(10, 2) NOT NULL,
quantidade INT NOT NULL,
foreign key (idCategoria) references categorias (idCategoria)
);

CREATE TABLE Estoque (
idEstoque INT AUTO_INCREMENT PRIMARY KEY,
nome VARCHAR(255) NOT NULL,
imagem longblob,
categoria int,
descricao TEXT,
preco DECIMAL(10, 2) NOT NULL,
quantidade INT NOT NULL,
idProdutos int,
foreign key (idProdutos) references Produtos (idProdutos)
);

CREATE TABLE Carrinho (
idCarrinho INT AUTO_INCREMENT PRIMARY KEY,
nome_carrinho VARCHAR(255) NOT NULL,
imagem_carrinho LONGBLOB,

descricao_carrinho TEXT,
preco_carrinho DECIMAL(10, 2) NOT NULL,
quantidade_carrinho INT NOT NULL,
total_preco DECIMAL(10, 2) AS (preco_carrinho * quantidade_carrinho) ,
idProdutos INT,
idUsuario int,
foreign key (idProdutos) references Produtos (idProdutos),
foreign key (idUsuario) references usuario (idUsuario)
);


CREATE TABLE Enderecos (
    idEndereco INT AUTO_INCREMENT PRIMARY KEY,
    idUsuario int not null,
    rua VARCHAR(255) NOT NULL,
    numero VARCHAR(255)  NOT NULL,
    complemento VARCHAR(255),
    cidade VARCHAR(100) NOT NULL,
    estado VARCHAR(100) NOT NULL,
    cep VARCHAR(10) NOT NULL,
FOREIGN KEY (idUsuario) REFERENCES Usuario(idUsuario)

);	




CREATE TABLE Historico_Compras (
    idCompra INT AUTO_INCREMENT PRIMARY KEY,
    idUsuario INT NOT NULL,
    idProdutos INT NOT NULL,
    nome VARCHAR(255) NOT NULL,    
    descricao TEXT,
    preco DECIMAL(10, 2) NOT NULL,
    quantidade INT NOT NULL,
    total_preco DECIMAL(10, 2) AS (preco * quantidade) , 
    FOREIGN KEY (idUsuario) REFERENCES Usuario(idUsuario),
	FOREIGN KEY (idProdutos) REFERENCES produtos(idProdutos)

);


create table historico_produtos(
idHistoricoC INT AUTO_INCREMENT PRIMARY KEY,
idCompra int,
idProdutos int,
FOREIGN KEY (idProdutos) REFERENCES produtos(idProdutos),
FOREIGN KEY (idCompra) REFERENCES Historico_Compras(idCompra)
);


INSERT INTO Usuario (nome, senha, email, telefone, cpf) 
VALUES ('Jo√£o', 'senha123', 'joao@gmail.com', '1234567890', '11111111111'),
('Maria', 'senha456', 'maria@gmail.com', '1234567890', '11111111111');



DELIMITER $$

CREATE TRIGGER mandarProEstoque
AFTER INSERT ON Produtos
FOR EACH ROW
BEGIN
    INSERT INTO Estoque (nome, imagem, categoria, descricao, preco, quantidade, idProdutos)
    VALUES (NEW.nomeProdutos, NEW.imagem, NEW.categoria, NEW.descricao, NEW.preco, NEW.quantidade, NEW.idProdutos);
END $$

DELIMITER ;


DELIMITER $$

CREATE TRIGGER comprasUsuario
AFTER INSERT ON Enderecos
FOR EACH ROW
BEGIN
    INSERT INTO Historico_Compras (
        nome,
   
        descricao,
        preco,
        quantidade,
        idProdutos,
        idUsuario
    )
    SELECT
        nome_carrinho,
    
        descricao_carrinho,
        preco_carrinho,
        quantidade_carrinho,
        idProdutos,
        idUsuario
    FROM
        Carrinho
    WHERE
        idUsuario = NEW.idUsuario;

    DELETE FROM Carrinho WHERE idUsuario = NEW.idUsuario;
END $$

DELIMITER ;



SELECT
    idCarrinho,
    nome_carrinho,
    quantidade_carrinho,
    preco_carrinho,
    (quantidade_carrinho * preco_carrinho) AS total_preco
FROM
    Carrinho;




select * from enderecos;			

select * from usuario;	

select * from categorias;

select * from produtos;

select * from carrinho;

select * from estoque;	

select * from historico_compras;

select * from historico_produtos;

